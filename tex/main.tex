\documentclass[12pt]{article}

\usepackage{tikz, fontspec, xcolor, geometry, pgffor, intcalc, atbegshi, afterpage, rotating, pdfpages, eso-pic, etoolbox, luacode}
\geometry{
  paperwidth=303mm,
  paperheight=426mm,
  margin=0mm
}
\graphicspath{ {../pics/} }

%\usepackage{lua-visual-debug}

\InputIfFileExists{config.tex}{}{\input{config_default.tex}}

% -- Colors --
\definecolor{WeekdayNameColor}{HTML}{525254}
\definecolor{LineColor}{HTML}{5A5f7A}
\definecolor{ActiveDayNumberColor}{HTML}{525254}
\definecolor{InactiveDayNumberColor}{HTML}{A4A5A8}


\definecolor{BottomHelperLineColor}{HTML}{DFE3EE}

% -- Months Pictures --
\newcommand{\JanuarPicture}{Januar.png}
\newcommand{\FebruarPicture}{Februar.png}
\newcommand{\MärzPicture}{März.png}
\newcommand{\AprilPicture}{April.png}
\newcommand{\MaiPicture}{Mai.png}
\newcommand{\JuniPicture}{Juni.png}
\newcommand{\JuliPicture}{Juli.png}
\newcommand{\AugustPicture}{August.png}
\newcommand{\SeptemberPicture}{September.png}
\newcommand{\OktoberPicture}{Oktober.png}
\newcommand{\NovemberPicture}{November.png}
\newcommand{\DezemberPicture}{Dezember.png}

% -- Months Prompts --
\newcommand{\JanuarPrompt}{Januar.txt}
\newcommand{\FebruarPrompt}{Februar.txt}
\newcommand{\MärzPrompt}{März.txt}
\newcommand{\AprilPrompt}{April.txt}
\newcommand{\MaiPrompt}{Mai.txt}
\newcommand{\JuniPrompt}{Juni.txt}
\newcommand{\JuliPrompt}{Juli.txt}
\newcommand{\AugustPrompt}{August.txt}
\newcommand{\SeptemberPrompt}{September.txt}
\newcommand{\OktoberPrompt}{Oktober.txt}
\newcommand{\NovemberPrompt}{November.txt}
\newcommand{\DezemberPrompt}{Dezember.txt}

% -- Constants --
\newcommand{\NumberOfWeekdays}{7}
\newcommand{\NumberOfWeeks}{5}
\newcommand{\NumberOfDays}{\calculateValue{\NumberOfWeekdays * \NumberOfWeeks}}

\newcommand{\JanuarNumberOfDays}{31}
\newcommand{\FebruarNumberOfDays}{28}
\newcommand{\FebruarLeapYearNumberOfDays}{29}
\newcommand{\MärzNumberOfDays}{31}
\newcommand{\AprilNumberOfDays}{30}
\newcommand{\MaiNumberOfDays}{31}
\newcommand{\JuniNumberOfDays}{30}
\newcommand{\JuliNumberOfDays}{31}
\newcommand{\AugustNumberOfDays}{31}
\newcommand{\SeptemberNumberOfDays}{30}
\newcommand{\OktoberNumberOfDays}{31}
\newcommand{\NovemberNumberOfDays}{30}
\newcommand{\DezemberNumberOfDays}{31}

% -- Spacings --
\newcommand{\SpacingsUnit}{cm}
\newcommand{\TopVerticalSpacing}{1.5}
\newcommand{\MonthNameVerticalSpacing}{1.75}
\newcommand{\LineWidth}{0.025}
\newcommand{\WeekdayNamesHeight}{2}
\newcommand{\GridWidth}{27}
\newcommand{\GridStep}{\calculateValue{\GridWidth / \NumberOfWeekdays}}

\newcommand{\DayNumberVerticalSpacing}{\GridStep * 0.15}
\newcommand{\DayNumberHorizontalSpacing}{\GridStep * 0.2}


\newcommand{\BottomHelperLineVerticalSpacing}{\calculateValue{42.6 - 30.3}}

% -- Font Sizes --

\newcommand{\MonthNameFontSize}{\fontsize{64pt}{12pt}\selectfont}
\newcommand{\WeekdayNameFontSize}{\fontsize{18pt}{12pt}\selectfont}
\newcommand{\DayNumberFontSize}{\fontsize{14pt}{12pt}\selectfont}

% -- Fonts --

\newcommand{\CalendarFont}{RobotoCondensedBold}

% -- Counters --

\newcounter{DayIndex}
\newcounter{Row}
\newcounter{Column}
\newcounter{NumberOfDaysForNextMonth}

\newcounter{FirstDayNumber}
\newcounter{NumberOfDaysOfLastMonth}

% -- Miscellaneous --

\newcommand\calculateValue[1]{\directlua{tex.sprint(#1)}}
\newcommand{\true}{1}
\newcommand{\false}{0}

\newcommand{\drawBottomHelperLine}{
    \begin{tikzpicture}[remember picture,overlay]
        \draw [remember picture,overlay,BottomHelperLineColor]
        ([yshift=\BottomHelperLineVerticalSpacing cm]current page.south west)
        --
        ([yshift=\BottomHelperLineVerticalSpacing cm]current page.south east);
\end{tikzpicture}
}

\newcommand{\CoverBackground}{
  \AddToShipoutPictureBG*{
    \AtPageLowerLeft{%
      \color{CoverColor}\rule{\paperwidth}{\paperheight}
    }
  }
}


\ExplSyntaxOn

\NewDocumentCommand{\IfNumberInListTF}{mmmm}
  {
    \bool_set_false:N \l_tmpa_bool

    \clist_set:Nx \l_tmpa_clist {#2}

    \clist_if_empty:NTF \l_tmpa_clist
      { #4 }
      {
        \clist_map_inline:Nn \l_tmpa_clist
          {
            \int_compare:nNnTF { \int_eval:n {#1} } = { \int_eval:n {##1} }
              { \bool_set_true:N \l_tmpa_bool \clist_map_break: }
              { }
          }
        \bool_if:NTF \l_tmpa_bool {#3} {#4}
      }
  }

\ExplSyntaxOff

\def\isLeapYear{\false}

\newcommand{\SetIsLeapYear}[1]{%
  \ifnum\numexpr#1-4*(#1/4)=0\relax
    \ifnum\numexpr#1-100*(#1/100)=0\relax
      \ifnum\numexpr#1-400*(#1/400)=0\relax
        \def\isLeapYear{\true}%
      \else
        \def\isLeapYear{\false}%
      \fi
    \else
      \def\isLeapYear{\true}%
    \fi
  \else
    \def\isLeapYear{\false}%
  \fi
}

\SetIsLeapYear{\year}


\def\DayNumberOfLastMondayOfDecemberOfLastYear{0}

\newcount\LMYear
\newcount\LMCalc
\newcount\LMtmp
\newcount\LMWeekday
\newcount\LMOffset
\newcount\LMResult


\def\SetDayNumberOfLastMondayOfDecemberOfLastYear#1{%
  \begingroup

  % previous year
  \LMYear=#1\relax
  \advance\LMYear by -1\relax

  % y/4
  \LMtmp=\LMYear
  \divide\LMtmp by 4

  \LMCalc=\LMYear
  \advance\LMCalc by \LMtmp

  % y/100
  \LMtmp=\LMYear
  \divide\LMtmp by 100
  \advance\LMCalc by -\LMtmp

  % y/400
  \LMtmp=\LMYear
  \divide\LMtmp by 400
  \advance\LMCalc by \LMtmp

  % + 35 (Dec 31 constant)
  \advance\LMCalc by 35

  % mod 7
  \LMtmp=\LMCalc
  \divide\LMtmp by 7
  \multiply\LMtmp by 7
  \advance\LMCalc by -\LMtmp

  % weekday: Sun=1 ... Sat=7
  \LMWeekday=\LMCalc
  \advance\LMWeekday by 1

  % offset from Monday (Mon=2)
  \LMOffset=\LMWeekday
  \advance\LMOffset by -2
  \ifnum\LMOffset<0 \advance\LMOffset by 7\fi

  % last Monday
  \LMResult=31
  \advance\LMResult by -\LMOffset



  \xdef\DayNumberOfLastMondayOfDecemberOfLastYear{\the\LMResult}%

  \endgroup
}



\SetDayNumberOfLastMondayOfDecemberOfLastYear{\year}


\def\AppendToList#1#2{%
  \ifx#1\empty
    \xdef#1{#2}%
  \else
    \xdef#1{#1,#2}%
  \fi
}



% 1: Number of days of current month
% 2: Holidays of current month
% 3: Holidays of next month
\newcommand{\AddHolidaysOfNextMonth}[3]{
    \setcounter{DayIndex}{0}

    % Step day numbers of last month
    \ifnum \arabic{FirstDayNumber} < \calculateValue{\arabic{NumberOfDaysOfLastMonth} + 1}
        \foreach \inactiveDayNumber in {\arabic{FirstDayNumber}, ..., \arabic{NumberOfDaysOfLastMonth}} {
            \setcounter{Row}{\intcalcDiv{\arabic{DayIndex}}{\NumberOfWeekdays}}
            \setcounter{Column}{\intcalcMod{\arabic{DayIndex}}{\NumberOfWeekdays}}

	    \stepcounter{DayIndex}
        }
    \fi

    % Step day numbers of current month
    \foreach \activeDayNumber in {1, ..., #1} {
        \setcounter{Row}{\intcalcDiv{\arabic{DayIndex}}{\NumberOfWeekdays}}
        \setcounter{Column}{\intcalcMod{\arabic{DayIndex}}{\NumberOfWeekdays}}

        \ifnum \arabic{Row} > \calculateValue{\NumberOfWeeks - 2}
	    \ifnum \arabic{Column} = 0
	        \setcounter{FirstDayNumber}{\activeDayNumber}
	    \fi

	    \ifnum \arabic{Column} = 6
	        \setcounter{FirstDayNumber}{\calculateValue{#1 + 1}}
	    \fi
	\fi

        \ifnum \arabic{Row} > \calculateValue{\NumberOfWeeks - 1}
	    % The day index exceeds the maximal number of fields,
	    % such that the day number needs to be drawn at the beginning of calendar fields.
            \setcounter{Row}{\intcalcMod{\arabic{Row}}{\NumberOfWeeks}}
	\fi


	\stepcounter{DayIndex}
    }

    % Step day numbers of next month
    \ifnum \arabic{DayIndex} < \NumberOfDays
        \setcounter{NumberOfDaysForNextMonth}{\calculateValue{\NumberOfDays - \arabic{DayIndex}}}

        \foreach \inactiveDayNumber in {1,...,\arabic{NumberOfDaysForNextMonth}} {
            \setcounter{Row}{\intcalcDiv{\arabic{DayIndex}}{\NumberOfWeekdays}}
            \setcounter{Column}{\intcalcMod{\arabic{DayIndex}}{\NumberOfWeekdays}}

	    \IfNumberInListTF{\inactiveDayNumber}{#3}{
		\AppendToList{#2}{\calculateValue{#1 + \inactiveDayNumber}}
	    }{}

	    \stepcounter{DayIndex}
	}
    \fi

    \setcounter{NumberOfDaysOfLastMonth}{#1}
}


\setcounter{FirstDayNumber}{\DayNumberOfLastMondayOfDecemberOfLastYear}
\setcounter{NumberOfDaysOfLastMonth}{\DezemberNumberOfDays}
\AddHolidaysOfNextMonth\JanuarNumberOfDays\JanuarHolidays\FebruarHolidays
\AddHolidaysOfNextMonth\FebruarNumberOfDays\FebruarHolidays\MärzHolidays
\AddHolidaysOfNextMonth\MärzNumberOfDays\MärzHolidays\AprilHolidays
\AddHolidaysOfNextMonth\AprilNumberOfDays\AprilHolidays\MaiHolidays
\AddHolidaysOfNextMonth\MaiNumberOfDays\MaiHolidays\JuniHolidays
\AddHolidaysOfNextMonth\JuniNumberOfDays\JuniHolidays\JuliHolidays
\AddHolidaysOfNextMonth\JuliNumberOfDays\JuliHolidays\AugustHolidays
\AddHolidaysOfNextMonth\AugustNumberOfDays\AugustHolidays\SeptemberHolidays
\AddHolidaysOfNextMonth\SeptemberNumberOfDays\SeptemberHolidays\OktoberHolidays
\AddHolidaysOfNextMonth\OktoberNumberOfDays\OktoberHolidays\NovemberHolidays
\AddHolidaysOfNextMonth\NovemberNumberOfDays\NovemberHolidays\DezemberHolidays
\AddHolidaysOfNextMonth\DezemberNumberOfDays\DezemberHolidays\JanuarHolidays



% -- Calendar Commands --

% 1: Name of month
% 2: Color of text
\newcommand{\drawMonthName}[2]{
    \node at
    (\GridWidth / 2, \WeekdayNamesHeight + \MonthNameVerticalSpacing)
    { \MonthNameFontSize \textcolor{#2}{#1} };
}

\newcommand{\drawLineSeparator}{
    \draw [color = LineColor, line width = \LineWidth \SpacingsUnit]
    (0, \WeekdayNamesHeight)
    --
    (\GridWidth, \WeekdayNamesHeight);
}

\newcommand{\drawAllWeekdayNames}{
    \drawWeekdayName{0}{Montag}
    \drawWeekdayName{1}{Dienstag}
    \drawWeekdayName{2}{Mittwoch}
    \drawWeekdayName{3}{Donnerstag}
    \drawWeekdayName{4}{Freitag}
    \drawWeekdayName{5}{Samstag}
    \drawWeekdayName{6}{Sonntag}
}

% 1: Index of weekday {0, .. , 6}
% 2: Name of weekday
\newcommand{\drawWeekdayName}[2]{
    \node at
    (#1 * \GridStep + \GridStep / 2, \WeekdayNamesHeight * 0.53)
    { \WeekdayNameFontSize \vphantom{MontagDienstagMittwochDonnerstagFreitagSamstagSonntag} \textcolor{WeekdayNameColor}{#2} };
}

\newcommand{\drawGridLines}{
    \draw [step = \GridStep \SpacingsUnit, color = LineColor, line width = \LineWidth \SpacingsUnit]
    (0, \LineWidth / 2)
    grid
    (\NumberOfWeekdays * \GridStep, - \NumberOfWeeks * \GridStep - \LineWidth / 2);
}

% 1: Color of fields
\newcommand{\colorWeekendFields}[1]{
     \foreach \column in {5, 6} {
         \path [fill = #1, draw = none]
	 (\column * \GridStep, 0)
	 rectangle
	 (\calculateValue{\column + 1} * \GridStep, - \NumberOfWeeks * \GridStep);
     }
}



% 1: Number of days of current month
% 2: Holidays of current month
\newcommand{\drawDayNumbers}[2]{
    \setcounter{DayIndex}{0}

    % Draw day numbers of last month
    \ifnum \arabic{FirstDayNumber} < \calculateValue{\arabic{NumberOfDaysOfLastMonth} + 1}
        \foreach \inactiveDayNumber in {\arabic{FirstDayNumber}, ..., \arabic{NumberOfDaysOfLastMonth}} {
            \setcounter{Row}{\intcalcDiv{\arabic{DayIndex}}{\NumberOfWeekdays}}
            \setcounter{Column}{\intcalcMod{\arabic{DayIndex}}{\NumberOfWeekdays}}

            \drawInactiveDayNumber{\inactiveDayNumber}

	    \stepcounter{DayIndex}
        }
    \fi

    % Draw day numbers of current month
    \foreach \activeDayNumber in {1, ..., #1} {
        \setcounter{Row}{\intcalcDiv{\arabic{DayIndex}}{\NumberOfWeekdays}}
        \setcounter{Column}{\intcalcMod{\arabic{DayIndex}}{\NumberOfWeekdays}}

        \ifnum \arabic{Row} > \calculateValue{\NumberOfWeeks - 2}
	    \ifnum \arabic{Column} = 0
	        \setcounter{FirstDayNumber}{\activeDayNumber}
	    \fi

	    \ifnum \arabic{Column} = 6
	        \setcounter{FirstDayNumber}{\calculateValue{#1 + 1}}
	    \fi
	\fi

        \ifnum \arabic{Row} > \calculateValue{\NumberOfWeeks - 1}
	    % The day index exceeds the maximal number of fields,
	    % such that the day number needs to be drawn at the beginning of calendar fields.
            \setcounter{Row}{\intcalcMod{\arabic{Row}}{\NumberOfWeeks}}
	\fi

	\IfNumberInListTF{\activeDayNumber}{#2}{
            \drawActiveDayNumber{\activeDayNumber\ •}
	}{
            \drawActiveDayNumber{\activeDayNumber}
        }

	\stepcounter{DayIndex}
    }

    % Draw day numbers of next month
    \ifnum \arabic{DayIndex} < \NumberOfDays
        \setcounter{NumberOfDaysForNextMonth}{\calculateValue{\NumberOfDays - \arabic{DayIndex}}}

        \foreach \inactiveDayNumber in {1,...,\arabic{NumberOfDaysForNextMonth}} {
            \setcounter{Row}{\intcalcDiv{\arabic{DayIndex}}{\NumberOfWeekdays}}
            \setcounter{Column}{\intcalcMod{\arabic{DayIndex}}{\NumberOfWeekdays}}

	    \IfNumberInListTF{\calculateValue{#1 + \inactiveDayNumber}}{#2}{
            	\drawInactiveDayNumber{\inactiveDayNumber\ •}
	    }{
            	\drawInactiveDayNumber{\inactiveDayNumber}
            }

	    \stepcounter{DayIndex}
	}
    \fi

    \setcounter{NumberOfDaysOfLastMonth}{#1}
}

% 1: Number of day
\newcommand{\drawInactiveDayNumber}[1]{
    \node at
    (\calculateValue{\arabic{Column} + 1} * \GridStep - \DayNumberHorizontalSpacing, - \arabic{Row} * \GridStep - \DayNumberVerticalSpacing)
    { \DayNumberFontSize \textcolor{InactiveDayNumberColor}{#1} };
}

% 1: Number of day
\newcommand{\drawActiveDayNumber}[1]{
    \node at
    (\arabic{Column} * \GridStep + \DayNumberHorizontalSpacing, - \arabic{Row} * \GridStep - \DayNumberVerticalSpacing)
    { \DayNumberFontSize \textcolor{ActiveDayNumberColor}{#1} };
}


% 1: List of holidays
\newcommand{\colorHolidays}[1]{
    \foreach \dayNumber in #1 {
        \colorDay{\dayNumber}{HolidayColor!10}
    }
}

% 1: Number of day to be colored
% 2: Color of day field
\newcommand{\colorDay}[2]{
    \ifnum \arabic{FirstDayNumber} < \calculateValue{\arabic{NumberOfDaysOfLastMonth} + 1}
        \setcounter{DayIndex}{\calculateValue{\arabic{NumberOfDaysOfLastMonth} + 1 -\arabic{FirstDayNumber}}}
    \else
        \setcounter{DayIndex}{0}
    \fi
    \foreach \dayNumber in {1,...,#1} {
        \setcounter{Row}{\intcalcDiv{\arabic{DayIndex}}{\NumberOfWeekdays}}
        \setcounter{Column}{\intcalcMod{\arabic{DayIndex}}{\NumberOfWeekdays}}

        \ifnum \arabic{Row} > \calculateValue{\NumberOfWeeks - 1}
            \setcounter{Row}{\intcalcMod{\arabic{Row}}{\NumberOfWeeks}}
	\fi

	\stepcounter{DayIndex}
    }

    \colorCell{#2}
}

% 1: Color of cell
\newcommand{\colorCell}[1]{
    \path [fill = white, draw = none]
    (\arabic{Column} * \GridStep, -\arabic{Row} * \GridStep)
    rectangle
    (\calculateValue{\arabic{Column} + 1} * \GridStep, -\calculateValue{\arabic{Row} + 1} * \GridStep);

    \path [fill = #1, draw = none]
    (\arabic{Column} * \GridStep, -\arabic{Row} * \GridStep)
    rectangle
    (\calculateValue{\arabic{Column} + 1} * \GridStep, -\calculateValue{\arabic{Row} + 1} * \GridStep);
}

% 1: Name of month
% 2: Color of month name
% 3: Number of days of current month
% 4: List of holidays
\newcommand{\drawCalendarPage}[4]{
    \newpage
    \thispagestyle{empty}
    \setmainfont{\CalendarFont}
    \vspace*{\TopVerticalSpacing \SpacingsUnit}
    \begin{center}
        \begin{tikzpicture}
            \drawMonthName{#1}{#2}
            \drawLineSeparator
            \drawAllWeekdayNames
            \colorWeekendFields{#2!10}
	    \colorHolidays{#4}
            \drawGridLines
	    \drawDayNumbers{#3}{#4}
        \end{tikzpicture}
    \end{center}
}


\newcommand{\addPicturePage}[2]{%
  \clearpage
  \thispagestyle{empty}%
  \begin{tikzpicture}[remember picture,overlay]
    % Add an up-side down picture at the top of the page.
    \node[anchor=north west,inner sep=0] at (current page.north west) {%
      \rotatebox{180}{\includegraphics[width=\paperwidth,height=\paperwidth]{#2}}%
    };
    % Add a colored rectangle as an overlay at the top of the page.
    \fill[#1] (current page.north west) rectangle ([yshift=-2cm]current page.north east);
  \end{tikzpicture}%
  \clearpage
}


\newcommand{\drawCalendarYear}{
    \setcounter{FirstDayNumber}{\DayNumberOfLastMondayOfDecemberOfLastYear}
    \setcounter{NumberOfDaysOfLastMonth}{\DezemberNumberOfDays}

    \addPicturePage{JanuarColor}{\JanuarPicture}
    \drawCalendarPage{Januar}{JanuarColor}{\JanuarNumberOfDays}{\JanuarHolidays}

    \addPicturePage{FebruarColor}{\FebruarPicture}
    \ifnum \isLeapYear = \true
        \drawCalendarPage{Februar}{FebruarColor}{\FebruarLeapYearNumberOfDays}{\FebruarHolidays}
    \else
        \drawCalendarPage{Februar}{FebruarColor}{\FebruarNumberOfDays}{\FebruarHolidays}
    \fi

    \addPicturePage{MärzColor}{\MärzPicture}
    \drawCalendarPage{März}{MärzColor}{\MärzNumberOfDays}{\MärzHolidays}
    \addPicturePage{AprilColor}{\AprilPicture}
    \drawCalendarPage{April}{AprilColor}{\AprilNumberOfDays}{\AprilHolidays}
    \addPicturePage{MaiColor}{\MaiPicture}
    \drawCalendarPage{Mai}{MaiColor}{\MaiNumberOfDays}{\MaiHolidays}
    \addPicturePage{JuniColor}{\JuniPicture}
    \drawCalendarPage{Juni}{JuniColor}{\JuniNumberOfDays}{\JuniHolidays}
    \addPicturePage{JuliColor}{\JuliPicture}
    \drawCalendarPage{Juli}{JuliColor}{\JuliNumberOfDays}{\JuliHolidays}
    \addPicturePage{AugustColor}{\AugustPicture}
    \drawCalendarPage{August}{AugustColor}{\AugustNumberOfDays}{\AugustHolidays}
    \addPicturePage{SeptemberColor}{\SeptemberPicture}
    \drawCalendarPage{September}{SeptemberColor}{\SeptemberNumberOfDays}{\SeptemberHolidays}
    \addPicturePage{OktoberColor}{\OktoberPicture}
    \drawCalendarPage{Oktober}{OktoberColor}{\OktoberNumberOfDays}{\OktoberHolidays}
    \addPicturePage{NovemberColor}{\NovemberPicture}
    \drawCalendarPage{November}{NovemberColor}{\NovemberNumberOfDays}{\NovemberHolidays}
    \addPicturePage{DezemberColor}{\DezemberPicture}
    \drawCalendarPage{Dezember}{DezemberColor}{\DezemberNumberOfDays}{\DezemberHolidays}
}


% -- Calendar Content --

\AtBeginShipoutFirst{\drawBottomHelperLine}
\AtBeginShipout{\AtBeginShipoutAddToBox{\drawBottomHelperLine}}

\begin{document}

\begin{tikzpicture}[remember picture,overlay]
    \fill[CoverColor] (current page.north west) rectangle ([yshift=-\paperwidth]current page.north east);
    \node[anchor=north west,inner sep=0] at (current page.north west) {%
        \includegraphics[width=\paperwidth,height=\paperheight]{Cover.png}%
    };
\end{tikzpicture}%

\nopagecolor

\nopagecolor
\drawCalendarYear
\newpage

\begin{tikzpicture}[remember picture,overlay]
    \fill[CoverColor] (current page.north west) rectangle ([yshift=-\paperwidth]current page.north east);
\end{tikzpicture}%

\end{document}
